---
title: "Draftsim analysis"
output: html_notebook
---

Some R code to analyze Draftsim drafting results.

```{r}
require(dplyr)
require(ggplot2)
require(tidyr)
require(rgl)
require(car)
require(magick)
load("C:/Users/Sysadmin/Documents/draftsim/pairs variable M19 part 1 v3.RData")
```

Let me start with describing the data; the exact structure of this data is not that important for the analysis, below, but I will be referring to it, so we can as well describe it. This data comes from the analysis of 48137 drafts that users ran on draftsim web-site (http://draftsim.com) in August 2018. I then loaded this data in R, and wrote a simple code that went through final draft piles one by one, and calculate the total number of cases that every two cards from the set (i and j) were drafted together:

* pairs - a matrix of all card co-occurrences in different drafts

To make calculations simpler, I also counted the total number of times each card was drafted at all:

* freq - the total number of times each card was drafted

To visualize the cards nicely I also loaded a database that for each card stores some useful information about it:

* db - info about every card from this particular set

```{r}
names(db)
```

The fields that are important here are the id, the name, and the casting cost. All names I turned lowercase, replaced spaces with underscores, and purged commas, to make analysis easier. And the "cost" field I split into separate costs of each mana (WUBRG) using this command below. This was important, to classify cards into colors and guilds:

```{r}
db <- mutate(db,w = grepl("W",cost)*1,
                u = grepl("U",cost)*1,
                b = grepl("B",cost)*1,
                r = grepl("R",cost)*1,
                g = grepl("G",cost)*1) # Number of symbols for each mana in cost
```

All other fields may be ignored.

So, let's look at the "pairs" matrix. Again, it contains the data about every co-occurrence of every two cards in thefinal draft piles. That is, if out of entire 48137 drafts, cards i and j were drafted together only once, the ij element of this matrix will be equal to 1. If these two cards were co-drafted 100 times, the value will be equal to 100. Here's how it looks like right after it was built by the loop running through all draft results:

```{r}
image(pairs,axes=F,col = grey(seq(0, 1, length = 256)))
```
Here's the distribution of the upper part of "pairs" values:

(Tehnically this formula is a bit wrong, as it double-counts cards on the diagonal p_ii, for cards that were drafted in 2 copies, but it's close enough to the truth for a quick and dirty histogram)

```{r}
ggplot() + geom_histogram(aes(x=c(pairs+t(pairs))),bins=200) + theme_bw()
```
Some cards were drafted together thousands of times, but most were only drafted together a few hundred times or so. Here's a zoom-in on the leftmost part of the histogram.

```{r}
temp <- c(pairs+t(pairs))
ggplot() + geom_histogram(aes(x=temp[temp<1000]),bins=200) + theme_bw()
```
Out of curiosity, what's the rarest pair of cards drafted?

```{r}
min(temp)
```
```{r}
ij <- which(pairs == min(temp), arr.ind = TRUE)
ij
```
```{r}
db[ij[1],1]
```
```{r}
db[ij[2],1]
```
A 2-color mythic and a rare of a non-matching color. No wonder.



Well, let's go further. The next  thing we need to do now is to make this matrix symmetrical, and then normalize it. Let's make a copy of "pairs" variable, and move from relative numbers to probabilities:

p_ij = n_ij/nCards

Finally, let's move from mutual probabilities to relative probabilities. That is, let's assume that card i can be found in drafted hands with probability p_i = n_i/nCards , and similar probability for card j is denoted as p_j. Then, if the cards are drafted independently from each other (that is, if the player doesn't care about the presence of card i in their hand, while drafting card j, and vice versa), then we'll have p_ij = p_i * p_j

In practice some cards are of course drafted together more often, and so p_ij > p_i * p_j, while some cards are drafted together more rarely. We can quantify this preference (or anti-prefereence) as a coefficient a, with  the following formula:

a_ij = p_ij/(p_i * p_j)

In practice I tracked the number (not probability) that each pair of cards ended up in the same pile n_ij, as well as the number of times card i was present in the final pile n_i , and the same for card j: n_j. If a card was present in the final pile twice, it was accounted twice, both in the n_ij and in n_i. For these counts, in case of independence, we can expect

n_ij/nDrafts = n_i/nDrafts * n_j/Drafts * pileSize*(pileSize-1), 

where pileSize = 14*3 and so

k_ij = n_ij/(n_i * n_j) * nDrafts * 14*3


```{r}
nCards <- nrow(db)                 # Repeat, in case the data was reloaded
p <- pairs                         # Make a copy
for(jCard in 1:nCards) {
    for(iCard in 1:jCard) {
      p[iCard,jCard] <- p[iCard,jCard]/(freq[iCard]*freq[jCard])*nDrafts*14*3
      p[jCard,iCard] <- p[iCard,jCard]
    }
}

```

Now if we look at this matrix, it will look different:

```{r}
image(p,axes=F,col = grey(seq(0, 1, length = 256)))
```

What is the highest synergy, if calculated that way? 

```{r}
max(p)
```

And which pair of cards turned to be the most "synergistic"?

```{r}
ij <- which(p == max(p), arr.ind = TRUE)
db[ij[1],1]
```
```{r}
db[ij[2],1]
```

Curiously, it's a synergy of Elvish Clancaller with itself. The card is not surprizing, it's an elf lord after all, but it is curious that with this calculation, rares clearly have an edge over commons and non-commons, as while nobody would ever pass over two cool synergistic rares, drafted in two consecutive boosters, people would sometimes pass over a synergistic common or uncommon.

In case you were wondering, the second most synergistic pair in this set is a combo of "blanchwood_armor" with "druid_of_horns" (a cool enchantment and a cool creature that benefits from enchantments) that have a relative preference of 71.33 .